#cloud-config
#
# Copyright 2016 HLRS, University of Stuttgart
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

#
# set the hostname the same as the physical node, but prefix it with 'v'
#
hostname: __VHOSTNAME__

#
# mount the NFS shares
#
mounts:
 - [ "__VM_NFS_HOME__", /home, "nfs", "uid=__USER_ID__,gid=__GROUP_ID__,rw,intr,noatime", "0", "0" ]
# - [ "__VM_NFS_OPT__", /opt, "nfs", "uid=__USER_ID__,gid=__GROUP_ID__,rw,intr,noatime", "0", "0" ]
# - [ "__VM_NFS_WS__", /workspace, "nfs", "uid=__USER_ID__,gid=__GROUP_ID__,rw,intr,noatime", "0", "0" ]

#
# create files
#
files:
 # PBS job env file
  /etc/profile.d/pbsVirtualJobEnv.sh: |
    #!bin/bash
    file="/var/spool/torque/vm/vmJobEnvironment";
    [ -f "$file" ] && source $file;

#
# ping the physical host, otherwise it cannot see the VM's IP with the help of
# 'arp -an's and create a profile for the virtual job environment
#
run:
  - PUT: /app/
    command: "/usr/bin/udpping.so __HOSTNAME__ 3333 5 500"

